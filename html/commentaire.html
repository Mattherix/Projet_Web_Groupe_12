<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <title>Vos commentaires</title>
</head>
<body>
  <header w3-include-html="common/header.html"></header>
  <nav w3-include-html="common/navbar.html"></nav>

  <main>
    <h2>Vos commentaires</h2>
    <form onsubmit="return addCommentForm(this)">
      <label for="pseudo">Pseudo:</label>
      <input type="text" id="pseudo" name="pseudo">
      <label for="comment">Comment:</label>
      <input type="text" id="comment" name="comment">
      <input type="reset" value="Reset">
      <input type="submit" value="Commenter">
    </form>
    <table id="commentaires">
      <tr>
        <th>Pseudo</th>
        <th>Commentaire</th>
      </tr>
    </table>
  </main>

  <footer w3-include-html="common/footer.html"></footer>
  <script>
    w3.includeHTML();

    function setTabToLocalStorage(table) {
      localStorage.setItem("comments", JSON.stringify(table));
    }

    function getTabFromLocalStorage() {
      var data = localStorage.getItem("comments");
      if (data) {
        return JSON.parse(localStorage.getItem("comments"));
      } else {
        var defaultData = [
          ["Linus Torvalds", "Non Richard, non ..."],
          ["RMS", "Ce n'est pas Linux mais GNU/Linux"]
        ];
        setTabToLocalStorage(defaultData);
        return getTabFromLocalStorage();
      } 
    }

    function loadComments() {
      var tab = getTabFromLocalStorage();
      document.getElementById("commentaires").rows.length;
      tab.forEach(element => {
        addRowToTable(...element);
      });
    }

    function addRowToTable(pseudo, comment) {
      var comments = document.getElementById("commentaires");
      var row = comments.insertRow(1);

      var p = row.insertCell(0);
      var c = row.insertCell(1);

      p.innerHTML = pseudo;
      c.innerHTML = comment;
    }

    function newComment(pseudo, comment) {
      setTabToLocalStorage([[pseudo, comment], ...getTabFromLocalStorage()]);
      addRowToTable(pseudo, comment);
    }
    
    function addCommentForm(form) {
      var pseudo = form.elements["pseudo"].value;
      var comment = form.elements["comment"].value;

      if (pseudo && comment) {
        newComment(pseudo, comment);
      } else {
        alert("Merci de remplir les champs !");
      }
      
      form.elements["comment"].value = "";

      // To disable form
      return false;
    }
    loadComments();
  </script>
</body>
</html>